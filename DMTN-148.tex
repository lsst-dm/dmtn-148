\documentclass[DM,authoryear,toc]{lsstdoc}
% lsstdoc documentation: https://lsst-texmf.lsst.io/lsstdoc.html
\input{meta}

% Package imports go here.

% Local commands go here.

%If you want glossaries
%\input{aglossary.tex}
%\makeglossaries

\title{DM Calibration Products}

% Optional subtitle
% \setDocSubtitle{A subtitle}

\author{%
Christopher Z Waters
}

\setDocRef{DMTN-148}
\setDocUpstreamLocation{\url{https://github.com/lsst-dm/dmtn-148}}

\date{\vcsDate}

% Optional: name of the document's curator
% \setDocCurator{The Curator of this Document}

\setDocAbstract{%
The goal of this tech note is to provide a plan for the handling of calibration products in the Gen-3 Butler environment, including the construction, validation, certification, and deprecation.  This process is equally challenging with the current Gen-2 Butlers, but the hope is that with a clear goal in mind, the currently existing calibrations, for all calibration types and cameras, can be migrated to a common design that will be shared with Gen-3.  The current state, the end goal, and the transition steps between these are defined.
}

% Change history defined here.
% Order: oldest first.
% Fields: VERSION, DATE, DESCRIPTION, OWNER NAME.
% See LPM-51 for version number policy.
\setDocChangeRecord{%
  \addtohist{1}{YYYY-MM-DD}{Unreleased.}{Chris Waters}
}


\begin{document}

% Create the title page.
\maketitle
% Frequently for a technote we do not want a title page  uncomment this to remove the title page and changelog.
% use \mkshorttitle to remove the extra pages

% ADD CONTENT HERE
% You can also use the \input command to include several content files.

\section{Intro}

The goal of this tech note is to provide a plan for the handling of
calibration products in the Gen-3 Butler environment.  There are a
large number of these products currently in use, but many of them do
not have a clearly defined process to define, ingest, test, and
deprecate them.  The lack of documentation on how these processes work
has led to many implementations of similar paths, further complicating
the issue.


\section{The End State}

The final state that we wish to get to has the following properties:

\begin{itemize}
\item All calibration products are either lsst.afw.image.Exposure
  image data or an explicit calibration class in the \verb|ip_isr| package.
\item All calibration products are constructed from a DM Task in the
  \verb|cp_pipe| package, and have the input data and configuration
  parameters persisted with the calibration itself.  This guarantees
  that any product can be reconstructed in the future.
\item These provenance, config, and final product files may be saved
  to an \verb|obs_CAMERA_data| package on git for convenience.  This also allows
  these files to be migrated to other Butler repositories in a
  consistent fashion.
\item All calibration products are accepted for use and have a date
  range set manually, preventing test runs from being used
  inadvertently.  Calibrations ingested from git should supply
  appropriate date ranges.
\item Calibration information stored in a lsst.afw.cameraGeom object
  may be used, but is always assumed to be overridden by supplied
  calibration products.  No new calibration information should be
  stored in these objects, and currently existing calibration
  information should be deprecated.

\end{itemize}

\section{The Current State}

\subsection{Standard Calibrations}

The classic calibration products, \verb|BIAS|, \verb|DARK|, \verb|FLAT|, and \verb|FRINGE|, all
write FITS files that are indexed in Butler's calibRegistry.sqlite3
repository database.  These files are created by
\verb|pipe_drivers|/constructCalibs.py, and are ingested into the
repository upon acceptance by \verb|pipe_tasks|/ingestCalibs.py.  This
ingestion process sets the 'validStart' and 'validEnd' values to
restrict the usage of the calibration, as well as the 'calibDate',
which is used (along with calibration type, filter, and detector) to
uniquely identify the calibration on disk.

Although not formally a "classic" calibration product, the \verb|SKY|
calibration is produced, stored, and accessed the same way.

These calibrations are required to have the following header keywords
defined, which are used during ingest to define the rows of the
appropriate calibration database table.  I believe only \verb|OBSTYPE|
is required right now.

\begin{tabular}{l l}
  Keyword & Description \\
  \hline
  \verb|OBSTYPE| & Calibration type contained in this file. \\
  \verb|INSTRUME| & Instrument/camera this calibration belongs to. \\
  \verb|DETECTOR| & Integer identifier for the ccd/detector. \\
  \verb|FILTER| & Name of the physical filter or ``NONE''. \\
  \verb|CALIB_CREATION_DATE| & Creation date of the calibration. \\
  \verb|CALIB_CREATION_TIME| & Creation time of the calibration. \\
  \verb|CALIBDATE| & Concatenation of \verb|CALIB_CREATION_DATE| and \verb|CALIB_CREATION_TIME|.  Unique for set of OIDF.\\
  \verb|DATE| & Usage start datetime of the product (see validStart).  \\
  \verb|CALIB_ID| & DataId that can be used to request this calibration after ingest. \\
\end{tabular}

\subsection{``User-curated'' Calibrations}

The other inputs necessary for ISR have generally been described as
"user-curated".  These products are either defined by the \verb|CAMERA| as
part of the afw.cameraGeom description of the instrument, or are
variously persisted and accessed in unique ways.  Describing a path to
fixing this is a goal of this tech note.

As part of the \verb|DEFECTS| rework (RFC-595), there is now a fixed and
generic way to handle the ingest, if not necessarily the construction,
of that product.  The \verb|QE_CURVE| (RFC-625) has been implemented
following this process.  These \verb|DEFECTS|-like calibration products have
their origins as human-curated text files in the appropriate
\verb|obs_CAMERA_data| packages (and are thereby versioned through the
packages' git repositories).  The text file must be in a structured
format, to allow the header keywords to be read and assigned to a
metadata PropertyList.

For these products to be used, they must be converted into a FITS
format that can be read by ingestCalibs.py.  This is performed by the
\verb|pipe_tasks|/ingestCuratedCalibs.py script, which uses the metadata
information and the calibration product's python class to read the
text version and convert to a FITS file format that can be ingested by
ingestCalibs.py.

This updated calibration process removes the necessity that each
\verb|obs_CAMERA_data| package implement one-off mapper methods to allow the
product to be found.  However, only \verb|DEFECTS|, \verb|QE_CURVE|, and \verb|LINEARITY|
follow this system, leaving the remaining products to be handled with
camera-specific code and cameraGeom entries.  In addition to having
diverse implementations, these handlers are often rigid, and cannot be
versioned easily.

\section{Transitioning to Gen3/What We Should Expect From Gen3}

\subsection{A CalibrationBaseClass}
The first step to a consistent calibration system is to ensure that
all products in both generations use the \verb|DEFECTS|-like calibration
product system.  For FITS image products, this requires future
calibrations to be constructed with all of the header keyword values
listed above.

The remaining unconverted calibration types (\verb|CROSSTALK|, \verb|BFKERNEL|)
should be converted to use \verb|DEFECTS|-like class, most likely by defining
a CalibrationBaseClass, and making all of the calibration products
subclasses of that.  This would enforce that all calibrations can be
relied upon to provide getMetadata, setMetadata, readFits, writeFits,
readText, and writeText methods.  Gen2 Butler instances would then be
able to access all calibration products in a single consistent manner.
This also ensures that Gen2 and Gen3 can use the same calibration
products.

\subsection{Calibration Construction in Gen3}

Calibration products should be constructed using well defined
PipelineTask code.  This removes the need to delineate between
``calibrations'' and ``user-curated calibrations''.  The only
remaining difference between these two groups is what the initial
persisted data type is: ``calibrations'' are stored in FITS images, as
they represent corrections that are only meaningful as full images;
``user-curated calibrations'' can be visualized in a small number of
parameters, and so persisting these in a text format to allow user
inspection is reasonable.  ECSV and YAML are good formats for these
calibrations, and a calibration's readText/writeText methods should
implement one of these.

In addition to the calibration product, the PipelineTask code must
persist a record of the input data used for construction.  This, along
with the already persisted pipeline definition and task configuration,
allows the calibration to be regenerated by any user, making the
construction process much more transparent than it currently is.  A
YAML file containing the dataId parameters for all inputs would
satisfy this.  Appending additional construction statistics (for
example, weight factors applied to each input during the combination
stage) would be helpful in the validation process.

Newly generated calibration products will belong to a Gen3 collection,
and that collection will be used to manage the calibration through the
validation and certification process.  This collection may only
contain one entry for a given OIDF set.

\subsection{Validation}

Calibration products are not currently validated, largely due to the
opaque construction process.  Some set of proper validation tasks must
be made, applying the newly constructed product to a set of test
exposures prior to that calibration product's certification.  Applying
these validation tasks continuously as new data is taken will inform
the date ranges for which the product is certified.

\subsection{Certification}

Once a calibration product has been confirmed through validation to
correct the instrument effect it is designed for, it will be certified
with a date range denoting when the calibration is valid, and assigned
to a particular calibration collection (which may contain calibrations
the same OIDF values, as the validity range adds another dimension).
For FITS image calibrations, this is equivalent to a database
operation; no persisted data need change.  This is also acceptable for
text calibrations, although conversion to FITS (using the
CalibrationBaseClass methods) may be desired for IO speed. In
addition, as the text calibrations are human readable and easier to
manage, they should be exported to the appropriate \verb|obs_CAMERA_data|
package.  This provides a common versioned repository for the state of
the camera calibration that can be exported and used independently of
the Gen3 repository where they were constructed.  These exports should
also include the configuration and input data records.

\subsection{Modifying Calibrations}

Most calibration products need user intervention only to launch the
construction and to validate and certify the result.  However, it is
assumed that some of the products used (such as \verb|CAMERA| and \verb|QE_CURVE|
definitions) will not have a PipelineTask construction process.  The
version of these products stored in the \verb|obs_CAMERA_data| (or \verb|obs_CAMERA|
for the case of the \verb|CAMERA| calibration) repository will be ingested
into the Butler repository as needed.  These products should still
have as much configuration and provenance data as is possible, but
should also note any manual edits with a name and date.  This
provenance method should also be used for calibrations that need to be
augmented in non-algorithmic ways, such as \verb|DEFECTS|.

\subsection{Deprecating Calibrations}

Calibrations that should no longer be used (due to code improvements
or newly discovered problems) can be deprecated in Gen3 with
operations on the calibration collection that contains them.  This
will require tools for collection management, but this will be
entirely Butler database operations and will likely not be calibration
specific.

\section{Conclusion}



\appendix
% Include all the relevant bib files.
% https://lsst-texmf.lsst.io/lsstdoc.html#bibliographies

\begin{tabular}{l |c|c|l|l}
  Calibration product & Gen-2 Form & Gen-3 Form & Notes \\
  \hline
  \verb|BIAS| & & & \\
  \verb|DARK| & & & \\
  \verb|FLAT| & & & \\
  \verb|FRINGE| & & & \\
  \verb|SKY| & & & \\
  \verb|CAMERA| & & & \\
  \verb|DEFECTS| & & & \\
  \verb|CROSSTALK| & & & \\
  \verb|LINEARITY| & & & \\
  \verb|BFKERNE|L & & & \\
  \verb|QE_CURVE| & & & \\
  \verb|STRAYLIGHT| & & & \\
  \verb|ILLUMINATION| & & & \\
\end{tabular}

\section{References} \label{sec:bib}
\bibliography{local,lsst,lsst-dm,refs_ads,refs,books}

% Make sure lsst-texmf/bin/generateAcronyms.py is in your path
\section{Acronyms} \label{sec:acronyms}
\input{acronyms.tex}
% If you want glossary uncomment below -- comment out the two lines above
%\printglossaries





\end{document}
